<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Studio Tour â€¢ Citizen Science Dashboard</title>

  <!-- 360 viewer (Pannellum) -->
  <link rel="stylesheet" href="https://cdn.pannellum.org/2.5/pannellum.css" />
  <script src="https://cdn.pannellum.org/2.5/pannellum.js"></script>

  <!-- Charts (Plotly) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.27.0/plotly.min.js"></script>

  <style>
    :root{
      --bg: #0b0c10;
      --card: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.16);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.72);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    #panorama{ width:100vw; height:100vh; }

    .hint{
      position:fixed;
      left:12px; bottom:12px;
      z-index:50;
      background: var(--card);
      border:1px solid var(--border);
      backdrop-filter: blur(10px);
      padding:10px 12px;
      border-radius:14px;
      max-width: 760px;
    }
    .hint .title{ font-weight:700; margin-bottom:6px; }
    .hint .muted{ color: var(--muted); font-size:13px; line-height:1.45; }
    .hint .row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font: inherit;
    }
    .btn:hover{ background: rgba(255,255,255,0.10); }

    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.65);
      display:none;
      z-index:100;
      padding: 18px;
      overflow:auto;
    }
    .modal{
      max-width: 1100px;
      margin: 30px auto;
      background:#fff;
      color:#111;
      border-radius:16px;
      overflow:hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 12px 14px;
      border-bottom:1px solid #eee;
    }
    .modal-header h2{ margin:0; font-size:15px; }
    .modal-header button{
      border:0;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      background:#f2f2f2;
    }
    .modal-body{ padding: 12px 14px 14px; }

    .controls{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
      margin-bottom:10px;
    }
    .control{
      background:#fafafa;
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
    }
    .control label{
      display:block;
      font-size:12px;
      opacity:.8;
      margin-bottom:6px;
    }
    .control select{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #ddd;
      background:white;
    }

    #chart{ width:100%; height:460px; }
    #metaRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:8px;
      font-size:12px;
      opacity:.8;
      flex-wrap:wrap;
    }

    @media (max-width: 900px){
      .controls{ grid-template-columns: 1fr; }
      #chart{ height: 360px; }
      .hint{ max-width: calc(100% - 24px); }
    }
  </style>
</head>
<body>

  <div id="panorama"></div>

  <div class="hint">
    <div class="title">Studio Tour (Citizen Science â€¢ Full Sheet)</div>
    <div class="muted">
      Click sinks to open the dashboard. You can filter and choose chart type.
      Auto-refresh: <b>every 1 minute</b>.
    </div>
    <div class="row">
      <button class="btn" onclick="go('hall')">Hall</button>
      <button class="btn" onclick="go('kitchen')">Kitchen</button>
      <button class="btn" onclick="go('bathroom')">Bathroom</button>
      <button class="btn" onclick="openDashboard({Room:'Kitchen'})">Open Kitchen dashboard</button>
      <button class="btn" onclick="openDashboard({Room:'Bathroom'})">Open Bathroom dashboard</button>
      <button class="btn" onclick="openDashboard({})">Open Full dataset</button>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop" onclick="closeModalIfBackdrop(event)">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2 id="modalTitle">Citizen Science Dashboard</h2>
        <button onclick="closeModal()">Close âœ•</button>
      </div>
      <div class="modal-body">

        <div class="controls">
          <div class="control">
            <label>Chart type</label>
            <select id="chartType">
              <option value="bar">Bar (aggregated)</option>
              <option value="scatter">Scatter</option>
              <option value="box">Box</option>
            </select>
          </div>

          <div class="control">
            <label>X axis (category)</label>
            <select id="xField"></select>
          </div>

          <div class="control">
            <label>Y axis (numeric)</label>
            <select id="yField">
              <option value="Total viable count">Total viable count</option>
              <option value="Relative frequency/percentage">Relative frequency/percentage</option>
              <option value="Age">Age</option>
            </select>
          </div>

          <div class="control">
            <label>Color/Series by (optional)</label>
            <select id="seriesField"></select>
          </div>

          <div class="control">
            <label>Filter: Country</label>
            <select id="fCountry"></select>
          </div>

          <div class="control">
            <label>Filter: Household Device</label>
            <select id="fDevice"></select>
          </div>

          <div class="control">
            <label>Filter: Room</label>
            <select id="fRoom"></select>
          </div>

          <div class="control">
            <label>Filter: Sample Type</label>
            <select id="fSample"></select>
          </div>

          <div class="control">
            <label>Filter: Taxonomic unit</label>
            <select id="fTaxon"></select>
          </div>
        </div>

        <div class="row" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
          <button class="btn" style="color:#111; border-color:#ddd;" onclick="render()">Update chart</button>
          <button class="btn" style="color:#111; border-color:#ddd;" onclick="resetFilters()">Reset filters</button>
        </div>

        <div id="chart"></div>
        <div id="metaRow">
          <div id="rowCount">Rows: -</div>
          <div id="lastUpdated">Last updated: -</div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ==========================================================
  // YOUR API (Apps Script Web App URL)
  // ==========================================================
  const API_BASE_URL = "https://script.google.com/macros/s/AKfycbwce1RCf-lByZPa0fEkC4fvUSUxzyyGS90TS5Oorj9Q13LFYDxp1BL8XypZzEj1rqUmBQ/exec"; // <-- change this

  // Refresh every 1 minute
  const REFRESH_MS = 1 * 60 * 1000;

  // Your panorama images
  const PANOS = {
    hall: "./assets/panos/hall.jpg",
    kitchen: "./assets/panos/kitchen.jpg",
    bathroom: "./assets/panos/bathroom.jpg"
  };

  // State
  let viewer = null;
  let refreshTimer = null;
  let jsonpCleanup = null;

  let allHeaders = [];
  let allRows = [];
  let defaultFilters = {}; // passed from hotspot (e.g. {Room:'Kitchen'})

  // -----------------------------
  // Modal
  // -----------------------------
  function openModal(){ document.getElementById("modalBackdrop").style.display = "block"; }
  function closeModal(){
    document.getElementById("modalBackdrop").style.display = "none";
    stopAutoRefresh();
  }
  function closeModalIfBackdrop(e){ if (e.target.id === "modalBackdrop") closeModal(); }

  // -----------------------------
  // Hotspot icons
  // -----------------------------
  function hotspotIcon(div, emoji, title){
    div.style.width="44px";
    div.style.height="44px";
    div.style.borderRadius="999px";
    div.style.display="grid";
    div.style.placeItems="center";
    div.style.background="rgba(255,255,255,0.92)";
    div.style.boxShadow="0 10px 30px rgba(0,0,0,0.25)";
    div.style.cursor="pointer";
    div.title=title;
    div.innerHTML=emoji;
    div.style.fontSize="22px";
  }
  function arrowIcon(div, title){ hotspotIcon(div, "âžœ", title); }

  // -----------------------------
  // JSONP loader (whole sheet)
  // -----------------------------
  function loadAllJSONP(filtersObj) {
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      const script = document.createElement("script");

      window[cbName] = (data) => { cleanup(); resolve(data); };

      function cleanup() {
        if (script.parentNode) script.parentNode.removeChild(script);
        delete window[cbName];
      }
      jsonpCleanup = cleanup;

      script.onerror = () => { cleanup(); reject(new Error("JSONP load failed")); };

      const filtersParam = encodeURIComponent(JSON.stringify(filtersObj || {}));
      script.src = `${API_BASE_URL}?callback=${cbName}&filters=${filtersParam}`;
      document.body.appendChild(script);
    });
  }

  // -----------------------------
  // Helpers
  // -----------------------------
  function uniqueValues(rows, field) {
    const s = new Set();
    rows.forEach(r => {
      const v = r[field];
      if (v !== "" && v != null) s.add(String(v));
    });
    return ["(Any)", ...Array.from(s).sort((a,b)=>a.localeCompare(b))];
  }

  function setOptions(selectId, options, keepValue=true) {
    const el = document.getElementById(selectId);
    const old = el.value;
    el.innerHTML = "";
    options.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      el.appendChild(opt);
    });
    if (keepValue && options.includes(old)) el.value = old;
  }

  function getFilterValue(selectId) {
    const v = document.getElementById(selectId).value;
    return (v === "(Any)") ? "" : v;
  }

  function applyUIFilters(rows) {
    const f = {
      "Country": getFilterValue("fCountry"),
      "Room": getFilterValue("fRoom"),
      "Household Device": getFilterValue("fDevice"),
      "Sample Type": getFilterValue("fSample"),
      "Taxonomic unit": getFilterValue("fTaxon"),
    };

    return rows.filter(r => {
      return Object.keys(f).every(k => {
        if (!f[k]) return true;
        return String(r[k] ?? "") === String(f[k]);
      });
    });
  }

  function isNumber(n){ return typeof n === "number" && Number.isFinite(n); }

  // Aggregate for bar chart
  function groupMean(rows, xField, yField, seriesField) {
    const buckets = new Map(); // key -> {sum,count}
    rows.forEach(r => {
      const x = String(r[xField] ?? "");
      const y = r[yField];
      const s = seriesField ? String(r[seriesField] ?? "") : "";
      if (!x || !isNumber(y)) return;
      const key = seriesField ? `${s}|||${x}` : x;
      const cur = buckets.get(key) || { sum:0, count:0, x, s };
      cur.sum += y;
      cur.count += 1;
      buckets.set(key, cur);
    });

    const out = Array.from(buckets.values()).map(b => ({
      x: b.x,
      s: b.s,
      y: b.sum / b.count,
      n: b.count
    }));

    // sort by x label
    out.sort((a,b)=>a.x.localeCompare(b.x));
    return out;
  }

  // -----------------------------
  // Dashboard open
  // -----------------------------
  async function openDashboard(initialFilters) {
    defaultFilters = initialFilters || {};
    openModal();

    const titleParts = [];
    if (defaultFilters.Room) titleParts.push(`Room = ${defaultFilters.Room}`);
    document.getElementById("modalTitle").textContent =
      titleParts.length ? `Citizen Science Dashboard (${titleParts.join(", ")})` : "Citizen Science Dashboard";

    await fetchAndInit(defaultFilters);
    startAutoRefresh();
  }

  async function fetchAndInit(filtersObj) {
    const payload = await loadAllJSONP(filtersObj);
    if (payload.error) throw new Error(payload.error);

    allHeaders = payload.headers || [];
    allRows = payload.rows || [];

    // Choose categorical fields for X + series
    // (Exclude numeric ones by name; you can adjust)
    const numericFields = new Set(["Total viable count","Relative frequency/percentage","Age"]);
    const categorical = allHeaders.filter(h => !numericFields.has(h));

    setOptions("xField", categorical.length ? categorical : ["Room"], false);

    // seriesField: allow "(None)" + categorical fields
    setOptions("seriesField", ["(None)", ...categorical], false);

    // Populate filters based on loaded dataset
    setOptions("fCountry", uniqueValues(allRows, "Country"), false);
    setOptions("fRoom", uniqueValues(allRows, "Room"), false);
    setOptions("fDevice", uniqueValues(allRows, "Household Device"), false);
    setOptions("fSample", uniqueValues(allRows, "Sample Type"), false);
    setOptions("fTaxon", uniqueValues(allRows, "Taxonomic unit"), false);

    // Apply initial filter defaults into UI (e.g., Room=Kitchen)
    if (defaultFilters.Room) document.getElementById("fRoom").value = defaultFilters.Room;

    render(payload.meta?.updatedAt);
  }

  function resetFilters(){
    document.getElementById("fCountry").value = "(Any)";
    document.getElementById("fRoom").value = defaultFilters.Room ? defaultFilters.Room : "(Any)";
    document.getElementById("fDevice").value = "(Any)";
    document.getElementById("fSample").value = "(Any)";
    document.getElementById("fTaxon").value = "(Any)";
    render();
  }

  // -----------------------------
  // Render chart
  // -----------------------------
  function render(updatedAtIso){
    const chartType = document.getElementById("chartType").value;
    const xField = document.getElementById("xField").value;
    const yField = document.getElementById("yField").value;
    const seriesFieldRaw = document.getElementById("seriesField").value;
    const seriesField = (seriesFieldRaw === "(None)") ? "" : seriesFieldRaw;

    const rows = applyUIFilters(allRows);

    document.getElementById("rowCount").textContent = `Rows: ${rows.length}`;
    document.getElementById("lastUpdated").textContent =
      "Last updated: " + (updatedAtIso ? new Date(updatedAtIso).toLocaleString() : new Date().toLocaleString());

    // Build traces
    let traces = [];

    if (chartType === "bar") {
      const grouped = groupMean(rows, xField, yField, seriesField);

      if (seriesField) {
        const bySeries = new Map();
        grouped.forEach(g => {
          const arr = bySeries.get(g.s) || [];
          arr.push(g);
          bySeries.set(g.s, arr);
        });
        traces = Array.from(bySeries.entries()).map(([s, arr]) => ({
          type: "bar",
          name: s || "(blank)",
          x: arr.map(d => d.x),
          y: arr.map(d => d.y),
        }));
      } else {
        traces = [{
          type: "bar",
          x: grouped.map(d => d.x),
          y: grouped.map(d => d.y),
          name: `Mean of ${yField}`,
        }];
      }

    } else if (chartType === "scatter") {
      if (seriesField) {
        const bySeries = new Map();
        rows.forEach(r => {
          const s = String(r[seriesField] ?? "");
          const x = r[xField];
          const y = r[yField];
          if (!isNumber(y) || x === "" || x == null) return;
          const arr = bySeries.get(s) || { x:[], y:[] };
          arr.x.push(String(x));
          arr.y.push(y);
          bySeries.set(s, arr);
        });
        traces = Array.from(bySeries.entries()).map(([s, arr]) => ({
          type: "scatter",
          mode: "markers",
          name: s || "(blank)",
          x: arr.x,
          y: arr.y
        }));
      } else {
        const x = [], y = [];
        rows.forEach(r => {
          if (!isNumber(r[yField])) return;
          if (r[xField] === "" || r[xField] == null) return;
          x.push(String(r[xField]));
          y.push(r[yField]);
        });
        traces = [{ type:"scatter", mode:"markers", x, y, name: yField }];
      }

    } else if (chartType === "box") {
      if (seriesField) {
        const bySeries = new Map();
        rows.forEach(r => {
          const s = String(r[seriesField] ?? "");
          const y = r[yField];
          if (!isNumber(y)) return;
          const arr = bySeries.get(s) || [];
          arr.push(y);
          bySeries.set(s, arr);
        });
        traces = Array.from(bySeries.entries()).map(([s, arr]) => ({
          type:"box",
          name: s || "(blank)",
          y: arr
        }));
      } else {
        const byX = new Map();
        rows.forEach(r => {
          const x = String(r[xField] ?? "");
          const y = r[yField];
          if (!x || !isNumber(y)) return;
          const arr = byX.get(x) || [];
          arr.push(y);
          byX.set(x, arr);
        });
        traces = Array.from(byX.entries()).map(([x, arr]) => ({
          type:"box",
          name: x,
          y: arr
        }));
      }
    }

    Plotly.react("chart", traces, {
      title: `${chartType.toUpperCase()} â€¢ Y: ${yField}` + (chartType === "bar" ? " (mean)" : ""),
      margin: {l: 55, r: 20, t: 55, b: 65},
      xaxis: { title: chartType === "box" && seriesField ? seriesField : xField, automargin:true },
      yaxis: { title: yField, automargin:true },
      barmode: seriesField ? "group" : "relative",
    }, { responsive:true });
  }

  // -----------------------------
  // Auto refresh
  // -----------------------------
  function startAutoRefresh(){
    stopAutoRefresh();
    refreshTimer = setInterval(async () => {
      try {
        // Reload with the default hotspot filters, keep UI filters as-is
        const payload = await loadAllJSONP(defaultFilters);
        if (payload.error) return;
        allHeaders = payload.headers || allHeaders;
        allRows = payload.rows || allRows;
        render(payload.meta?.updatedAt);
      } catch (e) {
        console.error(e);
      }
    }, REFRESH_MS);
  }

  function stopAutoRefresh(){
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = null;
    if (jsonpCleanup) { jsonpCleanup(); jsonpCleanup = null; }
  }

  function go(sceneName){
    if (viewer) viewer.loadScene(sceneName);
  }

  // -----------------------------
  // Pannellum scenes
  // -----------------------------
  viewer = pannellum.viewer("panorama", {
    default: {
      firstScene: "hall",
      autoLoad: true,
      showControls: true,
      sceneFadeDuration: 700
    },
    scenes: {
      hall: {
        type: "equirectangular",
        panorama: PANOS.hall,
        title: "Hall",
        hfov: 100,
        hotSpots: [
          { pitch: -2, yaw: 30, type: "custom",
            createTooltipFunc: (d)=>arrowIcon(d,"Go to Kitchen"),
            clickHandlerFunc: ()=>viewer.loadScene("kitchen")
          }
        ]
      },
      kitchen: {
        type: "equirectangular",
        panorama: PANOS.kitchen,
        title: "Kitchen",
        hfov: 100,
        hotSpots: [
          { pitch: -2, yaw: -150, type: "custom",
            createTooltipFunc: (d)=>arrowIcon(d,"Back to Hall"),
            clickHandlerFunc: ()=>viewer.loadScene("hall")
          },
          { pitch: -2, yaw: 20, type: "custom",
            createTooltipFunc: (d)=>arrowIcon(d,"Go to Bathroom"),
            clickHandlerFunc: ()=>viewer.loadScene("bathroom")
          },
          { pitch: -8, yaw: 55, type: "custom",
            createTooltipFunc: (d)=>hotspotIcon(d,"ðŸš°","Open Kitchen dashboard"),
            clickHandlerFunc: ()=>openDashboard({Room:"Kitchen"})
          }
        ]
      },
      bathroom: {
        type: "equirectangular",
        panorama: PANOS.bathroom,
        title: "Bathroom",
        hfov: 100,
        hotSpots: [
          { pitch: -2, yaw: -160, type: "custom",
            createTooltipFunc: (d)=>arrowIcon(d,"Back to Kitchen"),
            clickHandlerFunc: ()=>viewer.loadScene("kitchen")
          },
          { pitch: -8, yaw: 60, type: "custom",
            createTooltipFunc: (d)=>hotspotIcon(d,"ðŸš¿","Open Bathroom dashboard"),
            clickHandlerFunc: ()=>openDashboard({Room:"Bathroom"})
          }
        ]
      }
    }
  });
</script>
</body>
</html>
